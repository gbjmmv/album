{"version":3,"file":"user.js","sources":["stores/user.js"],"sourcesContent":["// 管理登录\r\n// 储存token，返回用户主页渲染内容\r\n\r\nimport {defineStore} from 'pinia'\r\nimport {ref} from \"vue\";\r\nimport {loginAPI, updateUserProfileAPI, getUserInfoAPI} from \"/api/user.js\"\r\n\r\n\r\nexport const useUserStore = defineStore('user', () => {\r\n    const userInfo = ref([])\r\n    const sessionKey = ref('')\r\n\r\n    const getUserInfo = async () => {\r\n        try {\r\n            const res = await getUserInfoAPI()\r\n            console.log(\"pinia中第一时间收到的数据\", res.data)\r\n            return res.data\r\n        } catch (error) {\r\n            console.error('获取用户信息失败:', error)\r\n        }\r\n\r\n    }\r\n    const login = async () => {\r\n        try {\r\n            // 获取登录code\r\n            const loginResult = await uni.login()\r\n            console.log(loginResult.code)\r\n\r\n            // 调用登录接口\r\n            const res = await loginAPI(loginResult.code)\r\n\r\n            // 存储返回数据\r\n            sessionKey.value = res.data.sessionKey\r\n            userInfo.value = res.data.userInfo\r\n            console.log(\"res\", res)\r\n\r\n            // 储存token到本地\r\n            uni.setStorageSync('token', res.data.token)\r\n            uni.setStorageSync('main album', res.data.userInfo[0].mainAlbumsId)\r\n\r\n            return {success: true}\r\n        } catch (error) {\r\n            console.error('登录失败：', error)\r\n            uni.showToast({\r\n                title: '登录失败',\r\n                icon: 'none'\r\n            })\r\n            return {success: false, error}\r\n        }\r\n    }\r\n\r\n\r\n    // 获取存储的信息\r\n    const getStoredInfo = () => {\r\n        console.log(userInfo.value[0].avatarUrl)\r\n        return {userInfo: userInfo.value}\r\n    }\r\n\r\n    const updateProfile = async (profileData) => {\r\n        try {\r\n            const updateData = {\r\n                nickname: profileData.nickname?.trim(),\r\n                partner_id: profileData.partner_id ? String(profileData.partner_id).trim() : '',\r\n                avatarFile: profileData.avatarFile\r\n            }\r\n            console.log(\"store:updateData\", updateData)\r\n            const res = await updateUserProfileAPI(updateData)\r\n\r\n            if (res?.data?.userInfo) {\r\n                userInfo.value = res.data.userInfo\r\n            }\r\n            return {success: true, data: res.data}\r\n        } catch (error) {\r\n            console.error('更新个人资料失败:', error)\r\n            // 错误已在 API 层处理，这里不需要重复显示 Toast\r\n            return {success: false, error: error.message || '更新失败'}\r\n        }\r\n    }\r\n\r\n    return {\r\n        sessionKey,\r\n        userInfo,\r\n        login,\r\n        getStoredInfo,\r\n        updateProfile,\r\n        getUserInfo\r\n    }\r\n})\r\n"],"names":["defineStore","ref","getUserInfoAPI","uni","loginAPI","updateUserProfileAPI"],"mappings":";;;AAQY,MAAC,eAAeA,cAAAA,YAAY,QAAQ,MAAM;AAClD,QAAM,WAAWC,cAAG,IAAC,EAAE;AACvB,QAAM,aAAaA,cAAG,IAAC,EAAE;AAEzB,QAAM,cAAc,YAAY;AAC5B,QAAI;AACA,YAAM,MAAM,MAAMC,wBAAgB;AAClCC,+DAAY,mBAAmB,IAAI,IAAI;AACvC,aAAO,IAAI;AAAA,IACd,SAAQ,OAAO;AACZA,oBAAAA,MAAA,MAAA,SAAA,wBAAc,aAAa,KAAK;AAAA,IACnC;AAAA,EAEJ;AACD,QAAM,QAAQ,YAAY;AACtB,QAAI;AAEA,YAAM,cAAc,MAAMA,cAAG,MAAC,MAAO;AACrCA,oBAAAA,MAAA,MAAA,OAAA,wBAAY,YAAY,IAAI;AAG5B,YAAM,MAAM,MAAMC,kBAAS,YAAY,IAAI;AAG3C,iBAAW,QAAQ,IAAI,KAAK;AAC5B,eAAS,QAAQ,IAAI,KAAK;AAC1BD,oBAAAA,2CAAY,OAAO,GAAG;AAGtBA,oBAAAA,MAAI,eAAe,SAAS,IAAI,KAAK,KAAK;AAC1CA,0BAAI,eAAe,cAAc,IAAI,KAAK,SAAS,CAAC,EAAE,YAAY;AAElE,aAAO,EAAC,SAAS,KAAI;AAAA,IACxB,SAAQ,OAAO;AACZA,oBAAAA,MAAc,MAAA,SAAA,wBAAA,SAAS,KAAK;AAC5BA,oBAAAA,MAAI,UAAU;AAAA,QACV,OAAO;AAAA,QACP,MAAM;AAAA,MACtB,CAAa;AACD,aAAO,EAAC,SAAS,OAAO,MAAK;AAAA,IAChC;AAAA,EACJ;AAID,QAAM,gBAAgB,MAAM;AACxBA,wBAAA,MAAA,OAAA,wBAAY,SAAS,MAAM,CAAC,EAAE,SAAS;AACvC,WAAO,EAAC,UAAU,SAAS,MAAK;AAAA,EACnC;AAED,QAAM,gBAAgB,OAAO,gBAAgB;;AACzC,QAAI;AACA,YAAM,aAAa;AAAA,QACf,WAAU,iBAAY,aAAZ,mBAAsB;AAAA,QAChC,YAAY,YAAY,aAAa,OAAO,YAAY,UAAU,EAAE,KAAI,IAAK;AAAA,QAC7E,YAAY,YAAY;AAAA,MAC3B;AACDA,oBAAAA,MAAA,MAAA,OAAA,wBAAY,oBAAoB,UAAU;AAC1C,YAAM,MAAM,MAAME,SAAoB,qBAAC,UAAU;AAEjD,WAAI,gCAAK,SAAL,mBAAW,UAAU;AACrB,iBAAS,QAAQ,IAAI,KAAK;AAAA,MAC7B;AACD,aAAO,EAAC,SAAS,MAAM,MAAM,IAAI,KAAI;AAAA,IACxC,SAAQ,OAAO;AACZF,oBAAAA,MAAA,MAAA,SAAA,wBAAc,aAAa,KAAK;AAEhC,aAAO,EAAC,SAAS,OAAO,OAAO,MAAM,WAAW,OAAM;AAAA,IACzD;AAAA,EACJ;AAED,SAAO;AAAA,IACH;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACH;AACL,CAAC;;"}