{"version":3,"file":"PhotoDetail.js","sources":["pages/PhotoDetail/PhotoDetail.vue","../../HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvUGhvdG9EZXRhaWwvUGhvdG9EZXRhaWwudnVl"],"sourcesContent":["<script setup>\nimport {ref, computed, onMounted, watch} from 'vue'\nimport {onLoad, onShow, onUnload} from '@dcloudio/uni-app'\nimport {usePhotoStore} from '@/stores/photo.js'\nimport {getAvatarUrl} from '@/utils/url.js'\n\n// 路由参数\n\n//当前显示的照片id\nconst photoId = ref(null)\nconst initialIndex = ref(0) // 初始索引位置\nconst source = ref('album') // 默认来源为相册\n\n// 状态\nconst currentIndex = ref(0) // 当前查看的照片索引\n\nconst showControls = ref(true)// 是否显示控制面板\nconst commentPopup = ref(null)\nconst deletePopup = ref(null)\nconst favoritePopup = ref(null)\nconst commentContent = ref('')\nconst favoriteMessage = ref({type: 'success', content: ''})\nconst isDragging = ref(false) // 是否正在拖拽\n\n// 获取照片store\nconst photoStore = usePhotoStore()\n\n// 根据来源选择照片数组\nconst photosData = computed(() => {\n  if (source.value === 'favorites') {\n    return photoStore.favoritePhotos\n  }\n  return photoStore.currentAlbumPhotos\n})\n\n// 当前显示的照片\nconst currentPhoto = computed(() => {\n  if (photosData.value.length > 0 && currentIndex.value < photosData.value.length) {\n    return photosData.value[currentIndex.value]\n  }\n  return {}\n})\n\n\n// 监视currentIndex变化，更新photoId\nwatch(currentIndex, (newIndex) => {\n  if (photosData.value[newIndex]) {\n    photoId.value = photosData.value[newIndex].id\n  }\n})\n\n// 初始化\nonLoad(async (option) => {\n  photoId.value = option.id\n\n  // 设置照片来源\n  if (option.source) {\n    source.value = option.source\n  }\n\n  if (option.index) {\n    initialIndex.value = parseInt(option.index)\n    currentIndex.value = initialIndex.value\n  }\n\n  // 如果是从收藏进入，确保收藏数据已加载\n  if (source.value === 'favorites') {\n    await photoStore.getFavoritePhotos()\n  }\n})\n\n// 每次显示页面时刷新当前照片索引\nonShow(() => {\n  console.log('Photo detail showed')\n  // 在相应照片列表中找到当前照片的索引\n  if (photoId.value && photosData.value.length > 0) {\n    const index = photosData.value.findIndex(photo => photo.id === parseInt(photoId.value))\n    if (index > -1) {\n      currentIndex.value = index\n    }\n  }\n})\n\n// 处理swiper切换\nconst handleSwiperChange = (e) => {\n  currentIndex.value = e.detail.current\n}\n\n\n// 切换UI控制显示\nconst toggleControls = () => {\n  showControls.value = !showControls.value\n}\n\n\n\n\n// 返回上一页\nconst goBack = () => {\n  uni.navigateBack()\n}\n\n// 显示评论输入框\nconst showCommentInput = () => {\n  if (!commentPopup.value) return\n  commentPopup.value.open()\n}\n\n// 关闭评论输入框\nconst closeCommentPopup = () => {\n  if (!commentPopup.value) return\n  commentPopup.value.close()\n  commentContent.value = ''\n}\n\n// 提交评论\nconst submitComment = async () => {\n  if (!commentContent.value.trim()) {\n    uni.showToast({\n      title: '评论内容不能为空',\n      icon: 'none'\n    })\n    return\n  }\n\n  const success = await photoStore.addComment(currentPhoto.value.id, commentContent.value)\n\n  if (success) {\n    closeCommentPopup()\n  }\n}\n\n// 切换收藏状态\nconst handleToggleFavorite = async () => {\n  const result = await photoStore.toggleFavorite(currentPhoto.value.id)\n\n  if (result) {\n    favoriteMessage.value = {\n      type: 'success',\n      content: result.message || (result.isFavorite ? '收藏成功' : '取消收藏成功')\n    }\n\n    if (favoritePopup.value) {\n      favoritePopup.value.open()\n    }\n  }\n}\n\n// 显示删除确认弹窗\nconst showDeleteConfirm = () => {\n  if (!deletePopup.value) return\n  deletePopup.value.open()\n}\n\n// 关闭删除确认弹窗\nconst closeDeletePopup = () => {\n  if (!deletePopup.value) return\n  deletePopup.value.close()\n}\n\n// 确认删除照片\nconst confirmDelete = async () => {\n  const success = await photoStore.deletePhoto(currentPhoto.value.id)\n\n  if (success) {\n    // 删除成功后返回相册页面\n    goBack()\n  }\n\n  closeDeletePopup()\n}\n\n// 格式化日期\nconst formatDate = (dateString) => {\n  if (!dateString) return '';\n\n  const date = new Date(dateString);\n\n  // 始终显示年月日和具体时间 (YYYY-MM-DD HH:MM)\n  return date.getFullYear() + '-' +\n      (date.getMonth() + 1).toString().padStart(2, '0') + '-' +\n      date.getDate().toString().padStart(2, '0') + ' ' +\n      date.getHours().toString().padStart(2, '0') + ':' +\n      date.getMinutes().toString().padStart(2, '0');\n};\n</script>\n\n<template>\n  <view class=\"photo-detail\">\n    <!-- Swiper 组件作为主要滑动容器 -->\n    <swiper\n        class=\"swiper\"\n        :current=\"currentIndex\"\n        @change=\"handleSwiperChange\"\n        :indicator-dots=\"false\"\n        :autoplay=\"false\"\n        :circular=\"false\"\n        :vertical=\"false\"\n        :duration=\"400\"\n        :disable-touch=\"false\"\n        easing-function=\"easeInOutCubic\"\n    >\n      <swiper-item v-for=\"(photo, index) in photosData\" :key=\"photo.id\" class=\"swiper-item\">\n        <view class=\"swiper-item-content\">\n          <image\n              :src=\"getAvatarUrl(photo.url)\"\n              mode=\"aspectFit\"\n              class=\"photo-image\"\n              @click=\"toggleControls\"\n              :style=\"{opacity: isDragging ? 0.7 : 1}\"\n          />\n        </view>\n      </swiper-item>\n    </swiper>\n\n    <!-- 控制面板 -->\n    <view v-if=\"showControls\" class=\"controls-overlay\" @click=\"toggleControls\" @touchmove.stop.prevent>\n      <!-- 顶部导航栏 -->\n      <view class=\"top-bar\" @click.stop>\n        <view class=\"page-indicator\">\n          <text class=\"page-text\">{{ currentIndex + 1 }}/{{ photosData.length }}</text>\n        </view>\n      </view>\n\n      <!-- 右侧操作按钮 -->\n      <view class=\"side-action-buttons\" @click.stop>\n        <view class=\"action-button\" @click=\"showCommentInput\">\n          <uni-icons type=\"chat\" size=\"28\" color=\"#FFFFFF\"/>\n        </view>\n        <view class=\"action-button\" @click=\"handleToggleFavorite\">\n          <uni-icons :type=\"currentPhoto?.isFavorite ? 'star-filled' : 'star'\" size=\"28\" color=\"#FFFFFF\"/>\n        </view>\n        <view class=\"action-button\" @click=\"showDeleteConfirm\">\n          <uni-icons type=\"trash\" size=\"28\" color=\"#FFFFFF\"/>\n        </view>\n      </view>\n\n      <!-- 底部评论面板 -->\n      <view class=\"comments-panel\" @click.stop>\n        <!-- 评论区 -->\n        <view class=\"comments-section\">\n          <view class=\"comments-header\">\n            <text class=\"comments-title\">评论 ({{ currentPhoto?.comments?.length || 0 }})</text>\n          </view>\n          <scroll-view scroll-y enable-flex show-scrollbar class=\"comments-list\">\n            <view v-if=\"!currentPhoto?.comments || currentPhoto.comments.length === 0\" class=\"no-comments\">\n              暂无评论，来添加第一条评论吧\n            </view>\n            <view v-else v-for=\"comment in currentPhoto.comments\" :key=\"comment.id\" class=\"comment-item\">\n              <view class=\"comment-content\">{{ comment.content }}</view>\n              <view class=\"comment-time\">{{ formatDate(comment.createdAt) }}</view>\n            </view>\n          </scroll-view>\n        </view>\n      </view>\n    </view>\n\n\n    <!-- 评论输入框弹窗 -->\n    <uni-popup ref=\"commentPopup\" type=\"bottom\">\n      <view class=\"comment-popup\">\n        <view class=\"comment-input-header\">\n          <text>添加评论</text>\n        </view>\n        <textarea\n            class=\"comment-textarea\"\n            v-model=\"commentContent\"\n            placeholder=\"请输入评论内容...\"\n            maxlength=\"200\"\n            auto-height\n        />\n        <view class=\"comment-buttons\">\n          <button class=\"comment-btn cancel\" @click=\"closeCommentPopup\">取消</button>\n          <button class=\"comment-btn confirm\" @click=\"submitComment\">确认</button>\n        </view>\n      </view>\n    </uni-popup>\n\n    <!-- 删除确认弹窗 -->\n    <uni-popup ref=\"deletePopup\" type=\"dialog\">\n      <uni-popup-dialog\n          type=\"warning\"\n          title=\"删除照片\"\n          content=\"确定要删除当前照片吗？此操作不可撤销。\"\n          :before-close=\"true\"\n          @confirm=\"confirmDelete\"\n          @close=\"closeDeletePopup\"\n      />\n    </uni-popup>\n\n    <!-- 收藏提示弹窗 -->\n    <uni-popup ref=\"favoritePopup\" type=\"message\">\n      <uni-popup-message\n          :type=\"favoriteMessage.type\"\n          :message=\"favoriteMessage.content\"\n          :duration=\"2000\"\n      />\n    </uni-popup>\n  </view>\n</template>\n\n\n<style>\n.photo-detail {\n  position: relative;\n  width: 100vw;\n  height: 100vh;\n  background-color: #000;\n}\n\n.swiper {\n  width: 100%;\n  height: 100%;\n}\n\n.swiper-item {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  width: 100%;\n  height: 100%;\n}\n\n.swiper-item-content {\n  width: 100%;\n  height: 100%;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}\n\n.photo-image {\n  width: 100%;\n  height: 100%;\n}\n\n.controls-overlay {\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  z-index: 10;\n  display: flex;\n  flex-direction: column;\n  justify-content: space-between;\n  /* 确保透明部分可以穿透事件到下层 */\n  pointer-events: none;\n}\n\n/* 为每个需要点击的子元素单独启用指针事件 */\n.top-bar,\n.side-action-buttons,\n.comments-panel,\n.nav-buttons {\n  pointer-events: auto;\n}\n\n.top-bar {\n  height: 88rpx;\n  padding: 0 30rpx;\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  background: linear-gradient(to bottom, rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0));\n}\n\n.back-button {\n  width: 60rpx;\n  height: 60rpx;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}\n\n.page-indicator {\n  padding: 6rpx 16rpx;\n  background-color: rgba(0, 0, 0, 0.3);\n  border-radius: 30rpx;\n}\n\n.page-text {\n  color: white;\n  font-size: 24rpx;\n}\n\n/* 导航按钮 */\n.nav-buttons {\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  z-index: 9;\n  pointer-events: none;\n}\n\n.nav-button {\n  position: absolute;\n  top: 50%;\n  transform: translateY(-50%);\n  width: 80rpx;\n  height: 80rpx;\n  background-color: rgba(0, 0, 0, 0.2);\n  border-radius: 50%;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  pointer-events: auto;\n}\n\n.nav-button.prev {\n  left: 20rpx;\n}\n\n.nav-button.next {\n  right: 20rpx;\n}\n\n/* 右侧操作按钮 */\n.side-action-buttons {\n  position: absolute;\n  right: 30rpx;\n  top: 50%;\n  transform: translateY(-50%);\n  display: flex;\n  flex-direction: column;\n  z-index: 20;\n}\n\n.action-button {\n  width: 90rpx;\n  height: 90rpx;\n  border-radius: 50%;\n  background-color: rgba(0, 0, 0, 0.5);\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  margin: 15rpx 0;\n}\n\n/* 底部评论面板 */\n.comments-panel {\n  position: absolute;\n  bottom: 0;\n  left: 0;\n  right: 0;\n  max-height: 40vh;\n  background: linear-gradient(to top, rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.5));\n  display: flex;\n  flex-direction: column;\n  z-index: 15;\n}\n\n.comments-section {\n  padding: 20rpx 30rpx;\n  display: flex;\n  flex-direction: column;\n}\n\n.comments-header {\n  margin-bottom: 20rpx;\n}\n\n.comments-title {\n  color: #fff;\n  font-size: 32rpx;\n  font-weight: bold;\n}\n\n.comments-list {\n  max-height: calc(40vh - 80rpx);\n  height: 100%;\n  flex: 1;\n}\n\n.no-comments {\n  padding: 30rpx 0;\n  color: rgba(255, 255, 255, 0.6);\n  font-size: 28rpx;\n  text-align: center;\n}\n\n.comment-item {\n  margin-bottom: 20rpx;\n  padding-bottom: 20rpx;\n  border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n}\n\n.comment-user {\n  font-size: 28rpx;\n  color: rgba(255, 255, 255, 0.8);\n  margin-bottom: 10rpx;\n}\n\n.comment-content {\n  font-size: 30rpx;\n  color: #fff;\n  margin-bottom: 10rpx;\n  word-break: break-all;\n}\n\n.comment-time {\n  font-size: 24rpx;\n  color: rgba(255, 255, 255, 0.5);\n}\n\n.comment-popup {\n  background-color: #fff;\n  border-radius: 16rpx 16rpx 0 0;\n  overflow: hidden;\n}\n\n.comment-input-header {\n  height: 88rpx;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  font-size: 32rpx;\n  border-bottom: 1px solid #f0f0f0;\n}\n\n.comment-textarea {\n  width: 100%;\n  min-height: 200rpx;\n  padding: 20rpx;\n  box-sizing: border-box;\n  font-size: 30rpx;\n}\n\n.comment-buttons {\n  display: flex;\n  height: 88rpx;\n  border-top: 1px solid #f0f0f0;\n}\n\n.comment-btn {\n  flex: 1;\n  height: 100%;\n  margin: 0;\n  border-radius: 0;\n  font-size: 32rpx;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}\n\n.comment-btn.cancel {\n  background-color: #f5f5f5;\n  color: #666;\n}\n\n.comment-btn.confirm {\n  background-color: #1890ff;\n  color: #fff;\n}\n</style>","import MiniProgramPage from 'C:/Users/ADMIN/Documents/HBuilderProjects/album/pages/PhotoDetail/PhotoDetail.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","usePhotoStore","computed","watch","onLoad","onShow","uni","MiniProgramPage"],"mappings":"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"}